@{
    ViewBag.Title = "Customer";
}

<div class="row">
    <div class="col-md-12">
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title">@ViewBag.Title</h3>
            </div>
            <!-- /.box-header -->
            <!-- form start -->
            @using (Html.BeginForm())
            {
                @Html.AntiForgeryToken()
                <div class="box-body">
                    <div class="row">
                        <div class="col-md-12">
                            <button type="button" class="btn btn-primary pull-right" data-toggle="modal" data-target="#AddCustomer" data-backdrop="static" data-keyboard="false"><i class="fa fa-plus"></i> Create New Customer</button>
                        </div>
                    </div>
                    <br />
                    <div class="row">
                        <div class="col-md-12">
                            <div class="table-responsive">
                                <table id="tblCustomer" class="table table-bordered table-striped">
                                    <thead>
                                        <tr>
                                            <th>Full Name</th>
                                            <th style="text-align: center">Mobile Number</th>
                                            <th>City</th>
                                            <th style="text-align: center">Is Active</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /.box-body -->
            }
        </div>
    </div>
</div>

<div class="modal fade" id="AddCustomer">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Create New Customer</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form class="form-horizontal">
                    <div class="box-body">
                        <div class="row">
                            <div class="col-xs-12 col-ms-12 col-md-12 col-lg-12">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="FirstName" class="col-md-12 control-label required">First Name</label>
                                            <div class="col-md-12">
                                                <input type="text" id="FirstName" class="form-control" maxlength="60" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="LastName" class="col-md-12 control-label required">Last Name</label>
                                            <div class="col-md-12">
                                                <input type="text" id="LastName" class="form-control" maxlength="60" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="MobileNumber" class="col-md-12 control-label required">Mobile Number</label>
                                            <div class="col-md-12">
                                                <input type="text" id="MobileNumber" class="form-control mobile" maxlength="10" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="City" class="col-md-12 control-label required">City</label>
                                            <div class="col-md-12">
                                                <input type="text" id="City" class="form-control" maxlength="250" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <div class="col-md-12">
                                                <label for="IsActive" class="control-label"><input id="IsActive" type="checkbox" checked /> Active</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="Save" class="btn btn-success"><i class="fa fa-save"></i> Save</button>
                <button id="Cancel" class="btn btn-danger"><i class="fa fa-times"></i> Cancel</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>

<div class="modal fade" id="EditCustomer">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Edit Customer</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form class="form-horizontal">
                    <div class="box-body">
                        <div class="row">
                            <div class="col-xs-12 col-ms-12 col-md-12 col-lg-12">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="EditFirstName" class="col-md-12 control-label required">First Name</label>
                                            <div class="col-md-12">
                                                <input type="hidden" id="EditID" />
                                                <input type="text" id="EditFirstName" class="form-control" maxlength="60" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="EditLastName" class="col-md-12 control-label required">Last Name</label>
                                            <div class="col-md-12">
                                                <input type="text" id="EditLastName" class="form-control" maxlength="60" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="EditMobileNumber" class="col-md-12 control-label required">Mobile Number</label>
                                            <div class="col-md-12">
                                                <input type="text" id="EditMobileNumber" class="form-control mobile" maxlength="10" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="EditCity" class="col-md-12 control-label required">City</label>
                                            <div class="col-md-12">
                                                <input type="text" id="EditCity" class="form-control" maxlength="250" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <div class="col-md-12">
                                                <label for="EditIsActive" class="control-label"><input id="EditIsActive" type="checkbox" checked /> Active</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="Update" class="btn btn-success"><i class="fa fa-save"></i> Save</button>
                <button id="CancelEdit" class="btn btn-danger"><i class="fa fa-times"></i> Cancel</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>

@section scripts {
    <script>
        $(document).ready(function () {
            GetCustomerList();

            $("#AddCustomer").on("hidden.bs.modal", function () {
                $("#FirstName").val('');
                $("#LastName").val('');
                $("#MobileNumber").val('');
                $("#City").val('');
                $("#IsActive").prop('checked', true);
            });

            $("#EditCustomer").on("hidden.bs.modal", function () {
                $("#EditID").val('');
                $("#EditFirstName").val('');
                $("#EditLastName").val('');
                $("#EditMobileNumber").val('');
                $("#EditCity").val('');
                $("#EditIsActive").prop('checked', false);
            });

            $("#Save").click(function () {
                if ($("#FirstName").val() == '') {
                    toastr.warning("Please enter first name");
                    return;
                }
                if ($("#LastName").val() == '') {
                    toastr.warning("Please enter last name");
                    return;
                }
                if ($("#MobileNumber").val() == '') {
                    toastr.warning("Please enter mobile number");
                    return;
                }
                if ($("#City").val() == '') {
                    toastr.warning("Please enter city");
                    return;
                }

                swal({
                    title: "<h3>Are you sure</h3>",
                    text: "Do you want to save customer information?",
                    type: 'question',
                    width: '35rem',
                    position: 'top',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showCancelButton: true,
                    confirmButtonText: 'Confirm',
                    confirmButtonClass: 'btn btn-primary',
                    cancelButtonClass: 'btn btn-danger',
                    buttonsStyling: false,
                    padding: 0,
                    imageWidth: 60,
                    imageHeight: 60
                }).then((result) => {
                    if (result.value) {
                        var token = $("[name=__RequestVerificationToken]").val();

                        justLoad();
                        
                        var changes = new Array();
                        changes.push('First Name="' + $("#FirstName").val() + '"');
                        changes.push('Last Name="' + $("#LastName").val() + '"');
                        changes.push('Mobile Number="' + $("#MobileNumber").val() + '"');
                        changes.push('City="' + $("#City").val() + '"');
                        changes.push('Is Active="' + $("#IsActive").prop('checked').toString() + '"');

                        $.ajax({
                            type: 'POST',
                            url: '@Url.Action("InsertCustomer")',
                            data: {
                                __RequestVerificationToken: token,
                                FirstName: $("#FirstName").val(),
                                LastName: $("#LastName").val(),
                                MobileNumber: $("#MobileNumber").val(),
                                City: $("#City").val(),
                                IsActive: $("#IsActive").prop('checked'),
                                auditChanges: changes
                            },
                            dataType: 'JSON',
                            success: function (data) {
                                if (data == "Success") {
                                    toastr.success("Successfully Saved");
                                    $("#AddCustomer").modal('hide');
                                    GetCustomerList();
                                }
                                else if (data == "Exists") {
                                    toastr.warning("Customer already exist");
                                }
                                else if (data == "Customer already exist") {
                                    toastr.warning("Customer already exist");
                                }
                                else if (data == "Mobile number already exist") {
                                    toastr.warning("Mobile number already exist");
                                }
                                else {
                                    toastr.error(data);
                                }
                                unLoad();
                            },
                            error: function (xhr, status, error) {
                                var errorMessage = xhr.status + ': ' + xhr.statusText
                                toastr.error('Error - ' + errorMessage);
                                unLoad();
                            }
                        });
                    }
                    else {
                        return false;
                    }
                });
            });

            $("#Update").click(function () {
                if ($("#EditFirstName").val() == '') {
                    toastr.warning("Please enter first name");
                    return;
                }
                if ($("#EditLastName").val() == '') {
                    toastr.warning("Please enter last name");
                    return;
                }
                if ($("#EditMobileNumber").val() == '') {
                    toastr.warning("Please enter mobile number");
                    return;
                }
                if ($("#EditCity").val() == '') {
                    toastr.warning("Please enter city");
                    return;
                }

                var hasChanges = false;
                var changes = new Array();
                if ($("#EditFirstName").val().toUpperCase() != $("#EditFirstName").attr("title").toUpperCase()) {
                    hasChanges = true;
                    changes.push('First Name="' + $("#EditFirstName").val() + '"');
                }

                if ($("#EditLastName").val().toUpperCase() != $("#EditLastName").attr("title").toUpperCase()) {
                    hasChanges = true;
                    changes.push('Last Name="' + $("#EditLastName").val() + '"');
                }

                if ($("#EditMobileNumber").val().toUpperCase() != $("#EditMobileNumber").attr("title").toUpperCase()) {
                    hasChanges = true;
                    changes.push('Mobile Number="' + $("#EditMobileNumber").val() + '"');
                }

                if ($("#EditCity").val().toUpperCase() != $("#EditCity").attr("title").toUpperCase()) {
                    hasChanges = true;
                    changes.push('City="' + $("#EditCity").val() + '"');
                }

                if ($("#EditIsActive").prop('checked').toString().toUpperCase() != $("#EditIsActive").attr("title").toUpperCase()) {
                    hasChanges = true;
                    changes.push('Is Active="' + $("#EditIsActive").prop('checked').toString() + '"');
                }

                if (!hasChanges) {
                    toastr.warning("No changes to update");
                    return;
                }

                swal({
                    title: "<h3>Are you sure</h3>",
                    text: "Do you want to update customer information?",
                    type: 'question',
                    width: '35rem',
                    position: 'top',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showCancelButton: true,
                    confirmButtonText: 'Confirm',
                    confirmButtonClass: 'btn btn-primary',
                    cancelButtonClass: 'btn btn-danger',
                    buttonsStyling: false,
                    padding: 0,
                    imageWidth: 60,
                    imageHeight: 60
                }).then((result) => {
                    if (result.value) {
                        var token = $("[name=__RequestVerificationToken]").val();

                        justLoad();
                        $.ajax({
                            type: 'POST',
                            url: '@Url.Action("UpdateCustomer")',
                            data: {
                                __RequestVerificationToken: token,
                                ID: $("#EditID").val(),
                                FirstName: $("#EditFirstName").val(),
                                LastName: $("#EditLastName").val(),
                                MobileNumber: $("#EditMobileNumber").val(),
                                City: $("#EditCity").val(),
                                IsActive: $("#EditIsActive").prop('checked'),
                                auditChanges: changes
                            },
                            traditional: true,
                            dataType: 'JSON',
                            success: function (data) {
                                if (data == "Success") {
                                    toastr.success("Successfully Saved");
                                    $("#EditCustomer").modal('hide');
                                    GetCustomerList();
                                }
                                else if (data == "Exists") {
                                    toastr.warning("Customer already exist");
                                }
                                else if (data == "Customer already exist") {
                                    toastr.warning("Customer already exist");
                                }
                                else if (data == "Mobile number already exist") {
                                    toastr.warning("Mobile number already exist");
                                }
                                else {
                                    toastr.error(data);
                                }
                                unLoad();
                            },
                            error: function (xhr, status, error) {
                                var errorMessage = xhr.status + ': ' + xhr.statusText
                                toastr.error('Error - ' + errorMessage);
                                unLoad();
                            }
                        });
                    }
                    else {
                        return false;
                    }
                });
            });

            $("#Cancel").click(function () {
                $("#AddCustomer").modal('hide');
            });

            $("#CancelEdit").click(function () {
                $("#EditCustomer").modal('hide');
            });
        });

        function GetCustomerList() {
            $("#tblCustomer tbody").empty();
            $.ajax({
                type: 'GET',
                url: '@Url.Action("GetCustomerList")',
                dataType: 'JSON',
                success: function (data) {
                    $.each(data, function (index, value) {
                        $("#tblCustomer tbody").append("<tr><td>" + value.FullName + "</td><td style='text-align:center;'>" +
                            value.MobileNumber + "</td><td>" +
                            value.City + "</td><td style='text-align:center;'>" +
                            (value.IsActive == true ? "<span class='label label-success'>" : "<span class='label label-danger'>") + value.IsActive + "</span>" + "</td><td style='text-align:center;'>" +
                            "<button class='btn btn-success' title='Edit' onclick=\"return EditCustomer('" + value.ID + "','" + value.FirstName + "','" + value.LastName + "','" + value.MobileNumber + "','" + value.City + "'," + value.IsActive + ");\"><i class='fa fa-edit'></i></button></td></tr>");
                    });
                },
                error: function (xhr, status, error) {
                    var errorMessage = xhr.status + ': ' + xhr.statusText
                    toastr.error('Error - ' + errorMessage);
                    unLoad();
                }
            });
        }

        function EditCustomer(ID, FirstName, LastName, MobileNumber, City, IsActive) {
            $("#EditID").val(ID);
            $("#EditFirstName").val(FirstName);
            $("#EditFirstName").attr("title",FirstName);
            $("#EditLastName").val(LastName);
            $("#EditLastName").attr("title", LastName);
            $("#EditMobileNumber").val(MobileNumber);
            $("#EditMobileNumber").attr("title", MobileNumber);
            $("#EditCity").val(City);
            $("#EditCity").attr("title", City);
            $("#EditIsActive").prop('checked', IsActive);
            $("#EditIsActive").attr("title", IsActive);
            $("#EditCustomer").modal({ backdrop: 'static', keyboard: false }, 'show');
            return false;
        }

    </script>
}